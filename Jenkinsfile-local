pipeline {
    agent any

    options {
        timestamps()
        ansiColor('xterm') // si en algún momento da error, quita esta línea o instala el plugin AnsiColor
    }

    environment {
        // Archivo de configuración de Docker Compose para el backend
        COMPOSE_FILE = 'docker-compose.back.yml'

        // Nombre del contenedor del backend
        BACK_CONTAINER_NAME = 'mplink-backend'
    }

    stages {
        stage('Checkout') {
            steps {
                // Esto usará la rama que configures en el job (ej: jenkins/local)
                checkout scm

                // opcional, pero útil para debug
                sh '''
                  echo "[DEBUG] Workspace actual:"
                  pwd
                  echo "[DEBUG] Archivos en el workspace:"
                  ls -la
                '''
            }
        }

        stage('Preparar .env') {
            when {
                expression { fileExists('.env.example') && !fileExists('.env') }
            }
            steps {
                sh '''
                  echo "[INFO] No existe .env, copiando desde .env.example..."
                  cp .env.example .env
                '''
            }
        }

        stage('Tests (clean + test + Jacoco check)') {
            steps {
                sh '''
                  echo "[INFO] Ejecutando fase de tests en CI (saltando tests porque son demostrativos)..."
                  chmod +x mvnw || true
                  ./mvnw -B clean package -Dmaven.test.skip=true
                '''
            }
        }

        // TODO: Problema con init.sql montándose como directorio en Jenkins
        // Por ahora levantamos solo el backend, la BD debe estar corriendo externamente
        // Investigar: bind mounts en Docker dentro de contenedor Jenkins

        stage('Levantar backend con Docker Compose') {
            steps {
                sh '''
                  echo "[INFO] Bajando contenedores previos del backend (si existen)..."
                  docker compose -f ${COMPOSE_FILE} down || true

                  echo "[INFO] Construyendo y levantando SOLO el backend con docker-compose..."
                  echo "[NOTA] El backend se conectará a: mplink-postgres:5432"
                  echo "[NOTA] Asegúrate de tener la BD corriendo en la misma red de Docker"

                  # Levantar solo el servicio del backend (construye la imagen automáticamente)
                  docker compose -f ${COMPOSE_FILE} up -d --build mplink-backend

                  echo "[INFO] Esperando 15 segundos para que el backend inicie..."
                  sleep 15

                  echo "[INFO] Estado de los contenedores:"
                  docker compose -f ${COMPOSE_FILE} ps

                  echo "[INFO] Logs del backend:"
                  docker compose -f ${COMPOSE_FILE} logs mplink-backend | tail -30
                '''
            }
        }

        stage('Smoke test (Actuator)') {
            steps {
                sh '''
                  echo "[INFO] Esperando 15 segundos adicionales para asegurar que el backend esté listo..."
                  sleep 15

                  echo "[INFO] Probando /actuator/health en http://localhost:8084..."
                  curl -f http://localhost:8084/actuator/health || {
                    echo "[ERROR] El backend no respondió OK en /actuator/health"
                    echo "[INFO] Logs completos del backend:"
                    docker compose -f ${COMPOSE_FILE} logs mplink-backend
                    exit 1
                  }

                  echo "[INFO] ✓ Backend OK según Actuator."
                '''
            }
        }
    }

    post {
        always {
            script {
                sh '''
                  echo "[INFO] Estado final de los contenedores:"
                  docker compose -f ${COMPOSE_FILE} ps
                  docker ps

                  echo "[INFO] Pipeline completado."
                  # Si quieres tumbar el backend automáticamente, descomenta la siguiente línea:
                  # docker compose -f ${COMPOSE_FILE} down
                '''
            }
        }
    }
}
