pipeline {
    agent any

    options {
        timestamps()
        ansiColor('xterm')
        timeout(time: 30, unit: 'MINUTES')
        buildDiscarder(logRotator(numToKeepStr: '5'))
        skipDefaultCheckout(true)
    }

    parameters {
        booleanParam(
            name: 'RUN_TESTS',
            defaultValue: false,
            description: 'Ejecutar tests de Maven antes del build de la imagen'
        )

        string(name: 'SPRING_PROFILE', defaultValue: 'prod', description: 'spring.profiles.active')
        string(name: 'HOST_PORT', defaultValue: '8080', description: 'Puerto expuesto en el host')
        string(name: 'CONTAINER_PORT', defaultValue: '8080', description: 'SERVER_PORT dentro del contenedor')

        string(name: 'DB_HOST', defaultValue: 'localhost', description: 'Host de la base de datos')
        string(name: 'DB_PORT', defaultValue: '5432', description: 'Puerto de la base de datos')
        string(name: 'DB_NAME', defaultValue: 'marketplace', description: 'Nombre de la base de datos')
        string(name: 'DB_USER', defaultValue: 'marketplace', description: 'Usuario de la base de datos')
        string(name: 'DB_PASSWORD', defaultValue: '', description: 'Password de la base de datos')

        string(name: 'DOCKER_NETWORK', defaultValue: 'marketplace_link_mplink_net', description: 'Red Docker para conectar el backend')
        string(name: 'FRONTEND_URL', defaultValue: 'http://localhost:5174', description: 'URL del frontend para CORS/redirecciones')

        string(name: 'AZURE_STORAGE_ENABLED', defaultValue: 'false', description: 'Habilitar integración con Azure Storage')
        string(name: 'AZURE_STORAGE_CONNECTION_STRING', defaultValue: 'unused', description: 'Connection string de Azure Storage')
        string(name: 'AZURE_STORAGE_CONTAINER_NAME', defaultValue: 'marketplace-images', description: 'Nombre del contenedor en Azure Storage')
    }

    environment {
        SPRING_PROFILE = "${params.SPRING_PROFILE}"

        HOST_PORT      = "${params.HOST_PORT}"
        CONTAINER_PORT = "${params.CONTAINER_PORT}"

        DB_HOST        = "${params.DB_HOST}"
        DB_PORT        = "${params.DB_PORT}"
        DB_NAME        = "${params.DB_NAME}"
        DB_USER        = "${params.DB_USER}"
        DB_PASSWORD    = "${params.DB_PASSWORD}"

        DOCKER_NETWORK = "${params.DOCKER_NETWORK}"
        FRONTEND_URL   = "${params.FRONTEND_URL}"

        AZURE_STORAGE_ENABLED           = "${params.AZURE_STORAGE_ENABLED}"
        AZURE_STORAGE_CONNECTION_STRING = "${params.AZURE_STORAGE_CONNECTION_STRING}"
        AZURE_STORAGE_CONTAINER_NAME    = "${params.AZURE_STORAGE_CONTAINER_NAME}"

        BACK_IMAGE          = 'marketplace-backend-local'
        BACK_TAG            = "${env.BUILD_NUMBER}"
        BACK_CONTAINER_NAME = 'marketplace_backend'
    }

    stages {
        stage('Checkout') {
            steps {
                checkout scm

                script {
                    env.GIT_COMMIT_SHORT = sh(
                        script: 'git rev-parse --short HEAD',
                        returnStdout: true
                    ).trim()

                    echo "Commit:              ${env.GIT_COMMIT_SHORT}"
                    echo "SPRING_PROFILE:      ${env.SPRING_PROFILE}"
                    echo "HOST_PORT:           ${env.HOST_PORT}"
                    echo "CONTAINER_PORT:      ${env.CONTAINER_PORT}"
                    echo "DB_HOST:             ${env.DB_HOST}"
                    echo "DB_PORT:             ${env.DB_PORT}"
                    echo "DB_NAME:             ${env.DB_NAME}"
                    echo "DB_USER:             ${env.DB_USER}"
                    echo "DOCKER_NETWORK:      ${env.DOCKER_NETWORK}"
                    echo "FRONTEND_URL:        ${env.FRONTEND_URL}"
                    echo "AZURE_STORAGE_ENABLED:           ${env.AZURE_STORAGE_ENABLED}"
                    echo "AZURE_STORAGE_CONTAINER_NAME:    ${env.AZURE_STORAGE_CONTAINER_NAME}"
                    echo "BACK_IMAGE:          ${env.BACK_IMAGE}:${env.BACK_TAG}"
                    echo "BACK_CONTAINER_NAME: ${env.BACK_CONTAINER_NAME}"
                }
            }
        }

        stage('Tests (opcional)') {
            when {
                expression { params.RUN_TESTS }
            }
            steps {
                script {
                    sh '''
                        docker run --rm \
                          -v "$PWD":/app \
                          -w /app \
                          maven:3.9-eclipse-temurin-21 \
                          mvn test
                    '''
                }
            }
        }

        stage('Detener contenedor anterior') {
            steps {
                script {
                    sh """
                        docker stop ${env.BACK_CONTAINER_NAME} 2>/dev/null || echo "Sin contenedor en ejecución"
                        docker rm   ${env.BACK_CONTAINER_NAME} 2>/dev/null || echo "Sin contenedor que remover"
                    """
                }
            }
        }

        stage('Build imagen Docker') {
            steps {
                script {
                    sh """
                        docker build \
                          -t ${env.BACK_IMAGE}:${env.BACK_TAG} \
                          -t ${env.BACK_IMAGE}:latest \
                          .
                    """
                }
            }
        }

        stage('Desplegar contenedor') {
            steps {
                script {
                    sh """
                        docker run -d \
                          --name ${BACK_CONTAINER_NAME} \
                          --network ${DOCKER_NETWORK} \
                          -p ${HOST_PORT}:${CONTAINER_PORT} \
                          -e JAVA_OPTS="-Dspring.profiles.active=${SPRING_PROFILE}" \
                          -e DB_HOST=${DB_HOST} \
                          -e DB_PORT=${DB_PORT} \
                          -e DB_NAME=${DB_NAME} \
                          -e DB_USER=${DB_USER} \
                          -e DB_PASSWORD=${DB_PASSWORD} \
                          -e SERVER_PORT=${CONTAINER_PORT} \
                          -e FRONTEND_URL=${FRONTEND_URL} \
                          -e AZURE_STORAGE_ENABLED=${AZURE_STORAGE_ENABLED} \
                          -e AZURE_STORAGE_CONNECTION_STRING=${AZURE_STORAGE_CONNECTION_STRING} \
                          -e AZURE_STORAGE_CONTAINER_NAME=${AZURE_STORAGE_CONTAINER_NAME} \
                          --label "com.docker.compose.project=marketplace_link" \
                          --restart unless-stopped \
                          ${BACK_IMAGE}:${BACK_TAG}
                    """
                }
            }
        }

        stage('Verificación') {
            steps {
                script {
                    sleep 5

                    def status = sh(
                        script: "docker ps --filter name=${env.BACK_CONTAINER_NAME} --format '{{.Status}}'",
                        returnStdout: true
                    ).trim()

                    if (!status.contains('Up')) {
                        error "El contenedor no está corriendo. Status: ${status}"
                    }

                    echo "Contenedor en ejecución: ${status}"

                    sh "docker logs --tail=80 ${env.BACK_CONTAINER_NAME} || true"
                }
            }
        }
    }

    post {
        success {
            script {
                echo "Backend desplegado correctamente."
                echo "URL:        http://localhost:${env.HOST_PORT}"
                echo "Imagen:     ${env.BACK_IMAGE}:${env.BACK_TAG}"
                echo "Contenedor: ${env.BACK_CONTAINER_NAME}"
            }
        }
        failure {
            script {
                echo "Despliegue backend fallido. Revisar logs."
                sh "docker logs ${env.BACK_CONTAINER_NAME} 2>/dev/null || echo 'Sin logs del contenedor'"
            }
        }
        cleanup {
            script {
                sh "docker image prune -f 2>/dev/null || true"
            }
        }
    }
}
