pipeline {
    agent any

    options {
        timestamps()
        ansiColor('xterm') // si en algún momento da error, quita esta línea o instala el plugin AnsiColor
    }

    environment {
        // Nombre de la imagen y contenedor del backend
        BACK_IMAGE = 'marketplace-link-back:local'
        BACK_CONTAINER_NAME = 'marketplace-link-back'

        // Red de Docker donde están las BDs (la que se crea con docker-compose.yml)
        DOCKER_NETWORK = 'marketplace_link_mplink_net'

        // Configuración de puertos
        HOST_PORT = '8084'
        CONTAINER_PORT = '8080'

        // Perfil de Spring
        SPRING_PROFILE = 'dev'

        // Configuración de Base de Datos
        DB_HOST = 'mplink_marketplace_db'
        DB_PORT = '5432'
        DB_NAME = 'marketplace_db'
        DB_USER = 'postgres'
        DB_PASSWORD = 'admin'
    }

    stages {
        stage('Checkout') {
            steps {
                // Esto usará la rama que configures en el job (ej: jenkins/local)
                checkout scm

                // opcional, pero útil para debug
                sh '''
                  echo "[DEBUG] Workspace actual:"
                  pwd
                  echo "[DEBUG] Archivos en el workspace:"
                  ls -la
                '''
            }
        }

        stage('Preparar .env') {
            when {
                expression { fileExists('.env.example') && !fileExists('.env') }
            }
            steps {
                sh '''
                  echo "[INFO] No existe .env, copiando desde .env.example..."
                  cp .env.example .env
                '''
            }
        }

        stage('Tests (clean + test + Jacoco check)') {
            steps {
                sh '''
                  echo "[INFO] Ejecutando fase de tests en CI (saltando tests porque son demostrativos)..."
                  chmod +x mvnw || true
                  ./mvnw -B clean package -Dmaven.test.skip=true
                '''
            }
        }

        stage('Build imagen backend') {
            steps {
                sh '''
                  echo "[INFO] Construyendo imagen Docker del backend..."
                  docker build -t ${BACK_IMAGE} .
                '''
            }
        }

        // TODO: Problema con init.sql montándose como directorio en Jenkins
        // Por ahora solo levantamos el backend, la BD debe estar corriendo externamente
        // Investigar: bind mounts en Docker dentro de contenedor Jenkins

        stage('Levantar backend con docker run') {
            steps {
                sh '''
                  echo "[INFO] Eliminando contenedor previo del backend (si existe)..."
                  docker rm -f ${BACK_CONTAINER_NAME} || true

                  echo "[INFO] Creando red de Docker si no existe..."
                  docker network create ${DOCKER_NETWORK} || echo "[INFO] La red ya existe"

                  echo "[INFO] Levantando backend con docker run..."
                  echo "[NOTA] El backend se conectará a: mplink_marketplace_db:5432"
                  echo "[NOTA] Asegúrate de tener la BD corriendo en la red ${DOCKER_NETWORK}"

                  docker run -d \
                    --name ${BACK_CONTAINER_NAME} \
                    --network ${DOCKER_NETWORK} \
                    -p ${HOST_PORT}:${CONTAINER_PORT} \
                    -e JAVA_OPTS="-Dspring.profiles.active=${SPRING_PROFILE}" \
                    -e DB_HOST=${DB_HOST} \
                    -e DB_PORT=${DB_PORT} \
                    -e DB_NAME=${DB_NAME} \
                    -e DB_USER=${DB_USER} \
                    -e DB_PASSWORD=${DB_PASSWORD} \
                    -e SERVER_PORT=${CONTAINER_PORT} \
                    -e FRONTEND_URL=http://localhost:5173 \
                    -e AZURE_STORAGE_ENABLED=false \
                    -e AZURE_STORAGE_CONNECTION_STRING=unused \
                    -e AZURE_STORAGE_CONTAINER_NAME=marketplace-images \
                    --label "com.docker.compose.project=marketplace_link" \
                    ${BACK_IMAGE}

                  echo "[INFO] Esperando 20 segundos para que el backend inicie..."
                  sleep 20

                  echo "[INFO] Logs del backend:"
                  docker logs ${BACK_CONTAINER_NAME} 2>&1 | tail -40
                '''
            }
        }

        stage('Smoke test (Actuator)') {
            steps {
                sh '''
                  echo "[INFO] Esperando 10 segundos adicionales para asegurar que el backend esté listo..."
                  sleep 10

                  echo "[INFO] Probando /actuator/health en http://localhost:8084..."
                  curl -f http://localhost:8084/actuator/health || {
                    echo "[ERROR] El backend no respondió OK en /actuator/health"
                    echo "[INFO] Logs completos del backend:"
                    docker logs ${BACK_CONTAINER_NAME}
                    exit 1
                  }

                  echo "[INFO] ✓ Backend OK según Actuator."
                '''
            }
        }
    }

    post {
        always {
            script {
                sh '''
                  echo "[INFO] Estado final de los contenedores:"
                  docker ps

                  echo "[INFO] Pipeline completado."
                  # Si quieres tumbar el backend automáticamente, descomenta la siguiente línea:
                  # docker rm -f ${BACK_CONTAINER_NAME}
                '''
            }
        }
    }
}
